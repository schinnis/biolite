function searchNote(products, search) {
    for (i=0; i < products.length; i++) {
        var sIndex = -1;
        if (products[i].handle == search) {
            sIndex = i;
            break;
        }
    }
    return sIndex;
}
function createCategorySelectBox(id, type) {
    var countWishlist = 0;
    var select = $('<select>').attr({
        name: 'wishlist',
        id: id
    });
    $('ul#navlist-wishlist a').each(function(ind) {
        if ($(this).attr('id') != 'current') {
            var option = $('<option>').attr({
                value: $(this).attr('class')
            }).html($(this).text());
            select.append(option);
            countWishlist++;
        }
    });
    if (countWishlist && type == 'item') {
        $('div.cm-' + id).append(select);
        $('div.wishlist-categories-select').css('display', 'block');
    } else if (countWishlist && type == 'all') {
        $('div.move-copy-block').append(select);
        $('div.copy-move').css('display', 'block');
    }
}

Shopify.Products = (function() {

   var config = { 
     howManyToShow: 3,
     howManyToStoreInMemory: 10, 
     wrapperId: 'wishlist-viewed-products', 
     templateId: 'wishlist-viewed-product-template',
     onComplete: null
   };

   return {

     showRecentlyViewed: function(params) {
       var params = params || {};
       // Update defaults.
       jQuery.extend(config, params);
       // How many products to show.
       var howManyToShow = config.howManyToShow;

       // If we have any to show.
       if (howManyToShow) {
         var template = jQuery('#' + config.templateId);
         var wrapper = jQuery('#' + config.wrapperId);
         var clear = false;
         // If we have a template and a div on a page to add the recently viewed products in.
         if (template.length && wrapper.length) {
           // We will keep track of callbacks.          
           var counter = 0;
           // Getting each product with an Ajax call and rendering it on the page.
           for (var i=0; i<howManyToShow; i++) {            
             jQuery.getJSON('/products/' + recentlyViewed[i].handle + '.js', function(product) {
               if (!clear) {
                   wrapper.html('');
                   clear = true;
               }
               // Render template with product and append to wrapper.
               template.tmpl(product).appendTo(wrapper);
               // append Note Text
               jQuery('#' + product.id).val(recentlyViewed[searchNote(recentlyViewed, product.handle)].note);
               // append select box category
               createCategorySelectBox(product.id, 'item');
               // Keeping track of how many we have done so far.
               counter++;
               // Have we done them all? If so, let's do the post-treatment.
               if (counter === howManyToShow) {
                 // If wrapper had been hidden.
                 wrapper.show();
                 // If we have a callback.
                 if (config.onComplete) {
                   try { config.onComplete() } catch (error) { }
                 }
               } 
             });
           }      
         }      
       }
     },
     getConfig: function() {
       return config;
     }
   };
 })();